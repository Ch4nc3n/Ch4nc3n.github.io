# Windows Win32k 越界写权限提升漏洞

## Summary of vulnerability

Windows Win32k Elevation of Privilege Vulnerability 

## Product version

Windows 10 , version 21H1，Chinese-Simplified, Build 10.0.19043.1165 <br>
BuildLabEx   :    19041.1.amd64fre.vb_release.191206-1406<br>

## Vulnerability describes

The vulnerability exists in file win32kbase.sys.<br>
The vulnerability occurs in functions :<br>
```
win32kbase!DirectComposition::CManipulationMarshaler::SetReferenceProperty
win32kbase!DirectComposition::CManipulationMarshaler::SetBufferProperty
```
We know that by analyzing function DirectComposition::CManipulationMarshaler::SetReferenceProperty,*(this + 35) refers to an object with resource_id 0x57.<br>

```
__int64 __fastcall DirectComposition::CManipulationMarshaler::SetReferenceProperty(DirectComposition::CManipulationMarshaler *this, struct DirectComposition::CApplicationChannel *a2, int a3, struct DirectComposition::CResourceMarshaler *a4, bool *a5)
{
  unsigned int v5; // ebx
  struct DirectComposition::CResourceMarshaler *v9; // rdx

  v5 = 0;
  if ( a3 != 8 || a4 && !(*(*a4 + 0x60i64))(a4, 0x57i64) )
    return -1073741811;
  v9 = *(this + 35);
  if ( v9 != a4 )
  {
    if ( v9 )
    {
      DirectComposition::CApplicationChannel::ReleaseResource(a2, v9);
      *(this + 35) = 0i64;
    }
    if ( a4 )
    {
      *(this + 35) = a4;//an object with resource_id 0x57
      DirectComposition::CResourceMarshaler::AddRef(a4);
    }
    *(this + 4) |= 0x100u;
    *a5 = 1;
  }
  return v5;
}
```
Interestingly, if the arguments are correct, calling function DirectComposition::CManipulationMarshaler::SetBufferProperty sets the last two bytes of *(this + 35)  to 0.<br>

```
__int64 __fastcall DirectComposition::CManipulationMarshaler::SetBufferProperty(DirectComposition::CManipulationMarshaler *this, struct DirectComposition::CApplicationChannel *a2, int a3, const void *a4, unsigned __int64 Size, bool *a6)
{
  int v9; // ebx
  int v10; // er8
  int v11; // er8
  int v12; // ecx
  unsigned __int64 v13; // rdx
  __int64 v14; // rsi

  v9 = 0;
  *a6 = 0;
  v10 = a3 - 7;
  if ( v10 )
  {
    v11 = v10 - 2;
    if ( !v11 )
    {
      if ( Size - 3 <= 0x7D && *a4 )
      {
        memmove(this + 152, a4, Size);
        *(this + 37) = Size;
        *(this + (Size >> 1) + 0x4C) = 0;//sets the last two bytes of *(this + 35)  to 0
        *a6 = 1;
        *(this + 4) |= 0x100u;
        return v9;
      }
      return -1073741811;
    }
 ******
 }
```

### Debug

Now,We can see win32kbase!DirectComposition::CManipulationMarshaler::SetReferenceProperty set the *(this + 35)  to ffff879f07a843d0.<br>
```
Breakpoint 0 hit
win32kbase!DirectComposition::CManipulationMarshaler::SetReferenceProperty+0x4f:
ffff87d1`821e63cf 483bd7          cmp     rdx,rdi
0: kd> !pool rdi
Pool page ffff879f07a843d0 region is Paged session pool
 ffff879f07a84000 size:  100 previous size:    0  (Free)       ....
 ffff879f07a84100 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84260 size:  160 previous size:    0  (Free)       ....
*ffff879f07a843c0 size:  160 previous size:    0  (Allocated) *DCio Process: ffffde8dfca8c080
		Pooltag DCio : DCOMPOSITIONTAG_INTERACTIONMARSHALER, Binary : win32kbase!DirectComposition::C
 ffff879f07a84520 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84680 size:  160 previous size:    0  (Free)       ....
 ffff879f07a847e0 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84940 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84aa0 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84c00 size:  160 previous size:    0  (Free)       ....
 ffff879f07a84d60 size:  160 previous size:    0  (Free)       ....
```

And then,We can see win32kbase!DirectComposition::CManipulationMarshaler::SetBufferPropertyset the *(this + 35)  last two bytes of *(this + 35)  to 0.<br>
The value of *(this + 35) goes from ffff879f07a843d0 to ffff879f07a80000.<br>

```
Breakpoint 1 hit
win32kbase!DirectComposition::CManipulationMarshaler::SetBufferProperty+0xf3:
ffff87d1`821e6233 664489a47598000000 mov   word ptr [rbp+rsi*2+98h],r12w
1: kd> dq rbp+rsi*2+98h l1
ffff879f`0077e338  ffff879f`07a843d0
1: kd> p
1: kd> dq rbp+rsi*2+98h l1
ffff879f`0077e338  ffff879f`07a80000
```

This means that if we can control the value of the memory block ffff879f07a80000, we can control the flow of the program. Because DirectComposition::CManipulationMarshaler::ReleaseAllReferences uses the value of *(this + 35).<br>

```
void __fastcall DirectComposition::CManipulationMarshaler::ReleaseAllReferences(DirectComposition::CManipulationMarshaler *this, struct DirectComposition::CApplicationChannel *a2)
{
  struct DirectComposition::CWeakReferenceBase **v3; // rbx
  unsigned int i; // edi
  struct DirectComposition::CResourceMarshaler *v6; // rdx

  v3 = (this + 64);
  for ( i = 0; i < 5; ++i )
  {
    if ( *v3 )
    {
      DirectComposition::CApplicationChannel::ReleaseWeakReference(a2, *v3);
      *v3 = 0i64;
    }
    ++v3;
  }
  v6 = *(this + 35);//the value of *(this + 35)
  if ( v6 )
  {
    DirectComposition::CApplicationChannel::ReleaseResource(a2, v6);
    *(this + 35) = 0i64;
  }
}

__int64 __fastcall DirectComposition::CApplicationChannel::ReleaseResource(DirectComposition::CApplicationChannel *this, struct DirectComposition::CResourceMarshaler *a2)
{
  unsigned int v2; // esi
  struct DirectComposition::CResourceMarshaler *v3; // rbx
  int v6; // eax
  char v7; // al
  __int64 v8; // rax
  __int64 v9; // rax
  size_t v10; // r8
  __int64 v11; // rcx
  int v12; // eax
  _QWORD *i; // rdx
  _QWORD *v14; // rax
  __int64 v15; // rcx
  _QWORD *v16; // rdx
  __int64 Src; // [rsp+38h] [rbp+10h] BYREF

  v2 = 0;
  v3 = a2;
  if ( a2 )
  {
    v2 = --*(a2 + 5);
    if ( v2 == 1 )
    {
      if ( (*(*a2 + 0x18i64))(a2) )// control the flow of the program
        DirectComposition::CResourceMarshaler::ReturnResourceLifetimeTag(v3, (this + 472));
    }
  ******
}
```

### Conclusion

There is no good method to exploit the vulnerability for the time being.<br>
Need to combine with other vulnerabilities to exploit, I can only create a blue screen.<br>
Here's the bug crash.<br>

```
NOTE: The trap frame does not contain all registers.
Some register values may be zeroed or incorrect.
rax=ffff81e3433e6020 rbx=0000000000000000 rcx=ffff819706dd6cb0
rdx=ffff8197076b0000 rsi=0000000000000000 rdi=0000000000000000
rip=ffff81e343247330 rsp=ffffd30227564890 rbp=ffff819706dd6cb0
 r8=0000000000000008  r9=0000000000000243 r10=0000000000000000
r11=0000000000000000 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         nv up ei ng nz na po nc
win32kbase!DirectComposition::CApplicationChannel::ReleaseResource+0x1c:
ffff81e3`43247330 ff4a14          dec     dword ptr [rdx+14h] ds:ffff8197`076b0014=????????
Resetting default scope

STACK_TEXT:  
ffffd302`27563ca8 fffff802`0f318ad2 : ffffd302`27563e10 fffff802`0f1831e0 ffff81e3`43200000 00000000`00000000 : nt!DbgBreakPointWithStatus
ffffd302`27563cb0 fffff802`0f3180b6 : ffff81e3`00000003 ffffd302`27563e10 fffff802`0f212110 ffffd302`27564360 : nt!KiBugCheckDebugBreak+0x12
ffffd302`27563d10 fffff802`0f1fd2d7 : 00000000`00000000 00000000`00000000 00000000`00000000 ffff8197`076b0014 : nt!KeBugCheck2+0x946
ffffd302`27564420 fffff802`0f250759 : 00000000`00000050 ffff8197`076b0014 00000000`00000002 ffffd302`27564700 : nt!KeBugCheckEx+0x107
ffffd302`27564460 fffff802`0f0a54f0 : ffffd407`732b5180 00000000`00000002 ffffd302`27564780 00000000`00000000 : nt!MiSystemFault+0x18d3b9
ffffd302`27564560 fffff802`0f20b35e : 00000000`00000090 00000000`72634344 00000000`00000090 00000000`000000ff : nt!MmAccessFault+0x400
ffffd302`27564700 ffff81e3`43247330 : 00000000`00000000 ffff8197`062863e0 ffff8197`062863e0 00000000`00000000 : nt!KiPageFault+0x35e
ffffd302`27564890 ffff81e3`433e6073 : ffff8197`076c1f18 00000000`00000000 ffff8197`076c1eb0 00000000`00000000 : win32kbase!DirectComposition::CApplicationChannel::ReleaseResource+0x1c
ffffd302`275648c0 ffff81e3`43247430 : ffff8197`076c1eb0 ffff8197`06dd6cb0 00000000`00000000 00000000`00000000 : win32kbase!DirectComposition::CManipulationMarshaler::ReleaseAllReferences+0x53
ffffd302`275648f0 ffff81e3`432472ca : 00000000`00000000 ffffd407`78bd28e0 ffff8197`075c0008 00000000`00000204 : win32kbase!DirectComposition::CApplicationChannel::ReleaseResource+0x11c
ffffd302`27564920 ffff81e3`43245ceb : ffffd407`7bfedc90 ffffd302`27564b80 ffff8197`075c0008 fffff802`0f00e649 : win32kbase!DirectComposition::CApplicationChannel::ReleaseResource+0x82
ffffd302`27564960 ffff81e3`432457a1 : ffff8197`06dd6cb0 00000000`00000000 00000000`00000000 ffffd407`7bfedc01 : win32kbase!DirectComposition::CApplicationChannel::ProcessCommandBufferIterator+0x48b
ffffd302`27564a20 ffff81e3`43c4edfe : ffffd407`77ce9080 00000000`00000008 00000005`8ff8eb48 00000005`8ff8eb44 : win32kbase!NtDCompositionProcessChannelBatchBuffer+0x1a1
ffffd302`27564ac0 fffff802`0f20ebb5 : 00000000`00000000 08878ef3`bd7e0000 ffffd302`27564b80 ffffd407`00000000 : win32k!NtDCompositionProcessChannelBatchBuffer+0x16
ffffd302`27564b00 00007ffe`0f513724 : 00007ff6`bbe7384d 00000000`00000286 00000000`00000000 00000005`8ff8c8f8 : nt!KiSystemServiceCopyEnd+0x25
00000005`8ff8ea88 00007ff6`bbe7384d : 00000000`00000286 00000000`00000000 00000005`8ff8c8f8 00000005`8ff8eb44 : win32u!NtDCompositionProcessChannelBatchBuffer+0x14
00000005`8ff8ea90 00000000`00000286 : 00000000`00000000 00000005`8ff8c8f8 00000005`8ff8eb44 00007ff6`000000ca : DirectComposition+0x384d
00000005`8ff8ea98 00000000`00000000 : 00000005`8ff8c8f8 00000005`8ff8eb44 00007ff6`000000ca 00000005`8ff8eaf8 : 0x286
```